---
title: "dataset_intro"
author: "Sarah Deussing, Ryan Steffe, Taylor Hill"
date: "2024-09-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Loading Packages
```{r}
library(tidyr)
library(tidyverse)
library(dplyr)
library(caret)
library(ggplot2)
library(readr)
library(xgboost)
library(stringr)
library(lubridate)
library(data.table)
```

## Read Dataset
```{r Read in data}
fraud <- read.csv("fraud_data.csv")
summary(fraud)
```


##Data Cleaning
There are two columns that contain dates to be converted (trans_date_trans_time and dob). We also want to make an 'age' column from the date of birth.
```{r}
# Make date column
fraud[c('trans_date', 'trans_time')] <- str_split_fixed(fraud$trans_date_trans_time, " ", 2)
fraud
fraud$trans_date <- as.Date(fraud$trans_date, "%d-%m-%Y")
fraud

# Make age column
fraud$dob <- as.Date(fraud$dob, "%d-%m-%Y")
fraud$age <- floor(interval(fraud$dob, now()) / years(1))

# Make time column
fraud$time2 <- hm(fraud$trans_time)

to_seconds <- function(time) {
  time_parts <- strsplit(time, ":")[[1]]  
  hours <- as.numeric(time_parts[1])     
  minutes <- as.numeric(time_parts[2])    
  
  total_seconds <- (hours * 3600) + (minutes * 60)  
  return(total_seconds)
}
fraud <- fraud %>%
  mutate(total_seconds = sapply(trans_time, to_seconds))
```

Clean the response variable
```{r}
unique(fraud$is_fraud)

# We see some entries that contain information beyond '1' or '0'.
fraud$is_fraud <- substring(fraud$is_fraud, 1, 1)

# We also want to convert this to numeric
fraud$is_fraud <- as.factor(fraud$is_fraud)
```


## Exploratory Plots
The response variable is 'is_fraud'. 1 denotes fraud, 0 denotes not fraud.

The five explanatory variables we are looking at are:
  - Category
  - Amount
  - Job
  - Time
  - Age

To do this, let's look at plots of each variable with our response (is_fraud).

```{r}
# 1. Category
ggplot(fraud, aes(x=category, group = is_fraud, fill = is_fraud)) + geom_bar() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = 'Count of Fraud in Transaction Categories', x = 'Category') 

# 2. Amount
ggplot(fraud, aes(x=amt, y=is_fraud)) + geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = 'Fraud at Different Amounts', x = 'Amount') + 
  coord_cartesian(xlim = c(0, 1500))

# 3. Job
job_df <- fraud %>%
  group_by(job) %>%
  mutate(is_fraud = as.numeric(is_fraud)) %>%
  summarize(count_fraud = sum(is_fraud)) %>%
  arrange(desc(count_fraud)) %>%
  head(15)
ggplot(job_df, aes(x=job, y = count_fraud)) + geom_col() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = 'Count of Fraud by Job', x = 'Job') 

# 4. Time
# By Month
date_df <- fraud %>%
  #filter(year(trans_date) == 2019) %>%
  mutate(month = month(trans_date),
         is_fraud = as.numeric(is_fraud)) %>%
  group_by(month) %>%
  summarize(count_fraud = sum(is_fraud))
ggplot(date_df, aes(x=month, y = count_fraud)) + geom_col() +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  labs(title = 'Count of Fraud Occurrences by Month',
       x = 'Month January-December')

#Splitting time column
fraud <- separate(fraud, trans_time, into = c("hours", "minutes"), sep = ":")
fraud$hours <- as.numeric(fraud$hours)
fraud$minutes <- as.numeric(fraud$minutes)
fraud$tod <- (fraud$hours*60)+fraud$minutes
fraud$tod <- fraud$tod/60
fraud

#Histogram of fraud occurences by time of day
ggplot(fraud, aes(x=tod, color = is_fraud)) + geom_histogram(fill = "black") +
  theme(axis.text.x = element_text(angle = 90), panel.background = element_rect("black"), panel.grid.minor = element_blank(),
    panel.grid.major = element_blank()) +
  labs(title = 'Count of Fraud Occurrences by Time of Day',
       x = 'Time of Day')
random

# By Hour of Day
hour_df <- fraud %>%
  mutate(hour = total_seconds %/% 3600,
         is_fraud = as.numeric(is_fraud)) %>%
  group_by(hour) %>%
  summarize(count_fraud = sum(is_fraud))
ggplot(hour_df, aes(x=hour, y=count_fraud)) + geom_line() +
  labs(title = 'Count of Fraud Occurrences by Hour of Day',
       x = 'Hour') +
  theme_minimal()

# 5. Age
ggplot(fraud, aes(x=age, y=is_fraud)) + geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = 'Fraud at Different Ages', x = 'Age')
```


- make a plot of fraud by longitude/latitude coordinates (sender and merchant)
```{r}
library(sf)

points_md <- st_as_sf(fraud, coords = c('long', 'lat'))
points_md <- st_set_crs(points, crs = 'EPSG:4326 - WGS 84')

#Plot it:
ggplot(points_md) + 
  geom_sf(aes(color = is_fraud))
```


## Logistic Regression
Because we have a binary response variable, we can run logistic regression. We are going to do this in 2 ways. First, we will look at the variables we explored above; then, we will run a lasso model with all of our variables.

#### Split into training + test sets
- split data
- look at balance, balance if need to.

#### Run Logistic Regression Model
- look at variance, accuracy, etc.

#### Run Lasso Logistic Regression Model
- look at variance, accuracy, etc.

## Time Series Modeling
- amount over time
- fraud over time??
