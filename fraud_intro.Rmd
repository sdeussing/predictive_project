---
title: "dataset_intro"
author: "Sarah Deussing, Ryan Steffe, Taylor Hill"
date: "2024-09-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Loading Packages
```{r}
library(tidyr)
library(tidyverse)
library(dplyr)
library(caret)
library(ggplot2)
library(readr)
library(xgboost)
library(stringr)
library(lubridate)
library(data.table)
library(plyr)
library(leaflet)
library(glmnet)
```

## Read Dataset
```{r Read in data}
fraud <- read.csv("fraud_data.csv")
summary(fraud)
```


##Data Cleaning
There are two columns that contain dates to be converted (trans_date_trans_time and dob). We also want to make an 'age' column from the date of birth.
```{r}
# Make date column
fraud[c('trans_date', 'trans_time')] <- str_split_fixed(fraud$trans_date_trans_time, " ", 2)
fraud$trans_date <- as.Date(fraud$trans_date, "%d-%m-%Y")

# Make age column
fraud$dob <- as.Date(fraud$dob, "%d-%m-%Y")
fraud$age <- floor(interval(fraud$dob, now()) / years(1))

# Make time column
fraud$time2 <- hm(fraud$trans_time)
fraud <- separate(fraud, trans_time, into = c("hours", "minutes"), sep = ":")
fraud$hours <- as.numeric(fraud$hours)
fraud$minutes <- as.numeric(fraud$minutes)
fraud$total_seconds <- (fraud$hours * 3600) + (fraud$minutes * 60) 
fraud$tod <- ((fraud$hours*60)+fraud$minutes)/60

```

Clean the response variable
```{r}
unique(fraud$is_fraud)

# We see some entries that contain information beyond '1' or '0'.
fraud$is_fraud <- substring(fraud$is_fraud, 1, 1)

# We also want to convert this to numeric
fraud$is_fraud <- as.factor(fraud$is_fraud)
```


## Exploratory Plots
The response variable is 'is_fraud'. 1 denotes fraud, 0 denotes not fraud.

The five explanatory variables we are looking at are:
  - Category
  - Amount
  - Job
  - Time
  - Age

To do this, let's look at plots of each variable with our response (is_fraud).

```{r}
# 1. Category
ggplot(fraud, aes(x=category, group = is_fraud, fill = is_fraud)) + geom_bar() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = 'Count of Fraud in Transaction Categories', x = 'Category') 

# 2. Amount
ggplot(fraud, aes(x=amt, y=is_fraud)) + geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = 'Fraud at Different Amounts', x = 'Amount') + 
  coord_cartesian(xlim = c(0, 1500))

# 3. Job
#job_df <- fraud %>%
#  group_by(job) %>%
#  select(is_fraud, job) %>%
#  mutate(is_fraud = as.numeric(is_fraud)) %>%
#  mutate(count_fraud = sum(is_fraud)) %>%
#  arrange(desc(count_fraud)) %>%
#  head(15)
#job_df
#ggplot(job_df, aes(x=job, y = count_fraud)) + geom_col() +
#  theme(axis.text.x = element_text(angle = 90)) +
#  labs(title = 'Count of Fraud by Job', x = 'Job')

job_df <- fraud %>%
  filter(is_fraud == 1) %>%
  select(is_fraud, job) %>%
  group_by(job) %>%
  count() %>%
  mutate(freq = freq) %>%
  arrange(desc(freq)) %>%
  head(10)
job_df
ggplot(job_df, aes(x=reorder(job, -freq), y = freq)) + geom_col() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = 'Count of Fraud by Job', x = 'Job')

# 4. Time
# By Month
#date_df <- fraud %>%
  #filter(year(trans_date) == 2019) %>%
#  mutate(month = month(trans_date),
#         is_fraud = as.numeric(is_fraud)) %>%
#  group_by(month) %>%
#  summarize(count_fraud = sum(is_fraud))
#date_df
#ggplot(date_df, aes(x=month, y = count_fraud)) + geom_col() +
#  theme(axis.text.x=element_blank(),
#        axis.ticks.x=element_blank()) +
#  labs(title = 'Count of Fraud Occurrences by Month',
#       x = 'Month January-December')

date_df <- fraud %>%
  filter(is_fraud == 1) %>%
  mutate(month = month(trans_date)) %>%
  select(is_fraud, month) %>%
  group_by(month) %>%
  count() %>%
  mutate(month_freq = freq) %>%
  select(month, month_freq)
date_df

ggplot(date_df, aes(x=month, y = month_freq)) + geom_col() +
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  labs(title = 'Count of Fraud Occurrences by Month',
       x = 'Month January-December')

#By Time of Day
ggplot(fraud, aes(x=tod, color = is_fraud)) + geom_histogram(fill = "black") +
  theme(axis.text.x = element_text(angle = 90), panel.background = element_rect("black"), panel.grid.minor = element_blank(),
    panel.grid.major = element_blank()) +
  labs(title = 'Count of Fraud Occurrences by Time of Day',
       x = 'Time of Day')

# By Hour of Day
#hour_df <- fraud %>%
#  mutate(hour = total_seconds %/% 3600,
#         is_fraud = as.numeric(is_fraud)) %>%
#  group_by(hour) %>%
#  summarize(count_fraud = sum(is_fraud))
#ggplot(hour_df, aes(x=hour, y=count_fraud)) + geom_line() +
#  labs(title = 'Count of Fraud Occurrences by Hour of Day',
#       x = 'Hour') +
#  theme_minimal()

# 5. Age
ggplot(fraud, aes(x=age, y=is_fraud)) + geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = 'Fraud at Different Ages', x = 'Age')

##NOTE: EVERYTHING CODED OUT WAS INFORMATION THAT WAS NOT WORKING. WE MIGHT HAVE TO LOOK INTO THAT. SOME OF THE CODE WAS REVISED IN ORDER FOR IT TO RUN
```


- make a plot of fraud by longitude/latitude coordinates (sender and merchant)
```{r}
pallette <- colorFactor(c("blue", "red"), domain = c(0, 1))

leaflet(fraud) %>%
  addTiles() %>%  
  addCircles(lng = ~long, lat = ~lat, 
             color = ~pallette(is_fraud), 
             radius = 5,  
             fillOpacity = 0.6, 
             popup = ~paste("Fraud Status:", is_fraud)) %>%
  addLegend("bottomright", 
            pal = pallette, 
            values = c(0, 1), 
            title = "Is Fraud", 
            labels = c("Not Fraud (0)", "Fraud (1)"))

##Question: Is our data only for the central and western parts of the United States. Not a big deal if it is, just want to be prepared when asked that question
```

## Logistic Regression
Because we have a binary response variable, we can run logistic regression. We are going to do this in 2 ways. First, we will look at the variables we explored above; then, we will run a lasso model with all of our variables.

#### Balance the dataset / Split into training + testing sets
```{r Balance count}
count(fraud$is_fraud)

ggplot(data = fraud, aes(fill = is_fraud)) +
    geom_bar(aes(x = is_fraud))+
    ggtitle("Number of samples in each class", subtitle = "Original dataset")+
    xlab("")+
    ylab("Samples")+
    scale_y_continuous(expand = c(0,0))+
    scale_x_discrete(expand = c(0,0))+
    theme(legend.position = "none", 
         legend.title = element_blank(),
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         panel.background = element_blank())
```

There are 12,601 cases of no-fraud and 1,845 cases of fraud in the dataset.
For our modeling, we will balance our dataset when we create the train and test sets. To do so, we will randomly sample 1,500 entries from each class to make the train set and 300 entries (of the remaining entries) from each class to make the test set.
```{r Make train}
fraud$id <- seq_len(nrow(fraud))
set.seed(1234567)

train1 <- fraud %>% 
  filter(is_fraud == 1) %>%
  sample_n(1500)

train0 <- fraud %>% 
  filter(is_fraud == 0) %>%
  sample_n(1500)

train_set <- bind_rows(train1, train0)

dim(train_set)
```

```{r Make test}
train_ids <- train_set$id
remaining <- fraud %>% 
  filter(!(id %in% train_ids))

test1 <- remaining %>% 
  filter(is_fraud == 1) %>%
  sample_n(300)

test0 <- remaining %>% 
  filter(is_fraud == 0) %>%
  sample_n(300)

test_set <- bind_rows(test1, test0)

dim(test_set)

# check identical rows
copies <- train_set %>%
  inner_join(test_set, by = names(train_set))
nrow(copies)

# Runnning the ggplot again to display the balanced data in the train_set
ggplot(data = train_set, aes(fill = is_fraud)) +
    geom_bar(aes(x = is_fraud))+
    ggtitle("Number of samples in each class", subtitle = "Train Set")+
    xlab("")+
    ylab("Samples")+
    scale_y_continuous(expand = c(0,0))+
    scale_x_discrete(expand = c(0,0))+
    theme(legend.position = "none", 
         legend.title = element_blank(),
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         panel.background = element_blank())

# Runnning the ggplot again to display the balanced data in the test_set
ggplot(data = test_set, aes(fill = is_fraud)) +
    geom_bar(aes(x = is_fraud))+
    ggtitle("Number of samples in each class", subtitle = "Test Set")+
    xlab("")+
    ylab("Samples")+
    scale_y_continuous(expand = c(0,0))+
    scale_x_discrete(expand = c(0,0))+
    theme(legend.position = "none", 
         legend.title = element_blank(),
         panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         panel.background = element_blank())
```

Now that we have randomly sampled the training and testing data to have equal number of is_fraud cases in each, we can move forward with our modeling. 


#### Run Logistic Regression Model
We are going to run a logistic regression model with a binary outcome variable is_fraud. 
- look at variance, accuracy, etc.
```{r}
##Building first logistic model
glm_fit <- glm(is_fraud~amt+city_pop+tod, data = train_set, family = binomial)
summary(glm_fit)

##Building second logistic model
glm_fit2 <- glm(is_fraud~amt+tod+age, data = train_set, family = binomial)
summary(glm_fit2)

##The AIC score for 'glm_fit2' is lower than 'glm_fit'. Therefore glm_fit2 is preferred##

##Making predictions with the glm_fit2 model##
glm.probs <- predict(object = glm_fit2, newdata = test_set, type = "response") 

##Making the probabilities into binary/classification##
cutoff <- 0.5 
glm.pred <- ifelse(glm.probs>cutoff, "0", "1")

##Making the confusion matrix##
confusion <- table(glm.pred, test_set$is_fraud)
confusion

##Calculating the accuracy
accuracy <- sum(diag(confusion))/sum(confusion)
accuracy

##Calculating the misclassification rate
misclassification <- 1 - accuracy
misclassification

##Calculating the Sensitivity
sensitivity <- confusion[1, 1] / (confusion[1, 1] + confusion[2, 1])
sensitivity

##Calculating the Specificity
specificity <- confusion[2, 2] / (confusion[2, 2] + confusion[1, 2])
specificity
```


#### Run Lasso Logistic Regression Model
- look at variance, accuracy, etc.
```{r}
##Scaling the training and test datasets
train_set2 <- train_set %>%
  select(tod, age, amt)
train_x_var <- scale(train_set2[, 1:3])

test_set2 <- test_set %>%
  select(tod, age, amt)
test_x_var <- scale(test_set2[, 1:3])

##Building the lasso regression model
fit_3 <- glmnet(x = train_x_var, # Fit explanatory variables
                y = train_set$is_fraud, # Fit response variable
                alpha = 1,
                lambda = 0.5,
                family = binomial)
coef(fit_3)

##All the coefficients returned, '.' indicating that they are 0 and essentially insignificant##
```


## Time Series Modeling
- amount over time
- fraud over time??
